<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Campaignbay Developer Docs</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="../images/favicon-32x32.png" sizes="32x32" />
    <link rel="icon" href="../images/favicon-192x192.png" sizes="192x192" />
    <link rel="apple-touch-icon" href="../images/favicon-180x180.png" />

    <link rel="stylesheet" href="../css/normalize.css">
    <link rel="stylesheet" href="../css/base.css?updated=1762860254">
    <link rel="stylesheet" href="../css/template.css?updated=1762860254">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0/css/all.min.css" integrity="sha256-ybRkN9dBjhcS2qrW1z+hfCxq+1aBdwyQM5wlQoQVt/0=" crossorigin="anonymous" />
            <script src="https://cdn.jsdelivr.net/npm/css-vars-ponyfill@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0/js/all.min.js" integrity="sha256-0vuk8LXoyrmCjp1f0O300qo1M75ZQyhH9X3J6d+scmk=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tarekraafat/autocomplete.js@7.2.0/dist/js/autoComplete.min.js"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-8KCYZ2CYMS', {
		'content_group' : 'Campaignbay Developer Docs',
	});
</script>
        <script src="../js/prism.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            window.dispatchEvent(new HashChangeEvent('hashchange'));
        });
    </script>
</head>
<body id="top">
    <header class="phpdocumentor-top-header">
    <section class="phpdocumentor-section">
        <div class="site-branding">
            <a class="site-logo" href="../index.html"><img src="../images/logo.png" alt="CampaignBay" /></a>
        </div>
        <nav class="main-navigation">
            <ul>
                <li><a href="../hooks/hooks.html">Hooks Reference</a></li>
                <li><a href="https://docs.wpanchorbay.com/">Documentation</a></li>
            </ul>
        </nav>
    </section>
</header>

<div class="phpdocumentor-header">
    <section class="phpdocumentor-section">
        <h1 class="phpdocumentor-title"><a href="../index.html">Campaignbay Developer Docs</a></h1>
        <section class="phpdocumentor-search">
    <label class="phpdocumentor-label">
        <span class="visually-hidden">Search (click ESC to close search results)</span>
        <input id="autoComplete" tabindex="1" type="search" class="phpdocumentor-field phpdocumentor-search__field" placeholder="Loading..." disabled />
    </label>
</section>

    </section>
</div>

    <main class="phpdocumentor">
        <div class="phpdocumentor-section">
            <aside class="phpdocumentor-column -four phpdocumentor-sidebar">
    
    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Namespaces</h2>
                                <h3 class="phpdocumentor-sidebar__root-namespace"><a href="../namespaces/default.html"><abbr title="\">Global</abbr></a></h3>
                                        <h4 class="phpdocumentor-sidebar__root-namespace"><a href="../namespaces/wpabcampaignbay.html"><abbr title="\WpabCampaignBay">WpabCampaignBay</abbr></a></h4>
                <ul class="phpdocumentor-list">
                                            <li><a href="../namespaces/wpabcampaignbay-admin.html"><abbr title="\WpabCampaignBay\Admin">Admin</abbr></a></li>
                                            <li><a href="../namespaces/wpabcampaignbay-api.html"><abbr title="\WpabCampaignBay\Api">Api</abbr></a></li>
                                            <li><a href="../namespaces/wpabcampaignbay-core.html"><abbr title="\WpabCampaignBay\Core">Core</abbr></a></li>
                                            <li><a href="../namespaces/wpabcampaignbay-data.html"><abbr title="\WpabCampaignBay\Data">Data</abbr></a></li>
                                            <li><a href="../namespaces/wpabcampaignbay-engine.html"><abbr title="\WpabCampaignBay\Engine">Engine</abbr></a></li>
                                            <li><a href="../namespaces/wpabcampaignbay-helper.html"><abbr title="\WpabCampaignBay\Helper">Helper</abbr></a></li>
                                    </ul>
                        </section>

        <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Packages</h2>
                    <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/campaignbay.html"><abbr title="\campaignbay">campaignbay</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WPAB.html"><abbr title="\WPAB">WPAB</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="../packages/WPAB-CampaignBay.html"><abbr title="\WPAB\CampaignBay">CampaignBay</abbr></a></li>
                            </ul>
                        </section>
    
    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Reports</h2>
                <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/deprecated.html">Deprecated</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/errors.html">Errors</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/markers.html">Markers</a></h3>
    </section>

    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Indices</h2>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../indices/files.html">Files</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../hooks/hooks.html">Hooks Reference</a></h3>
    </section>
</aside>

            <div class="phpdocumentor-column -eight phpdocumentor-content">
                    <ul class="phpdocumentor-breadcrumbs">
    </ul>

    <article class="phpdocumentor-element -file">
        <h2 class="phpdocumentor-content__title">ProductDiscount.php</h2>

                

        
                    <h3 class="phpdocumentor-elements__header" id="source-code">
                Source code
                <a href="#source-code" class="headerlink"><i class="fas fa-link"></i></a>
            </h3>
            <pre id="source-view" tabindex="-1" class="language-php line-numbers linkable-line-numbers"><code>&lt;?php

namespace WpabCampaignBay\Engine;

use WC_Product;
use WP_Error;
use WpabCampaignBay\Core\Common;
use WpabCampaignBay\Engine\CampaignManager;
use WpabCampaignBay\Helper\Helper;
use WpabCampaignBay\Helper\Woocommerce;

/**
 * The file that defines the Pricing Engine class.
 *
 * A class definition that handles all pricing interactions with WooCommerce.
 *
 * @link       https://wpanchorbay.com
 * @since      1.0.0
 *
 * @package    WPAB_CampaignBay
 * @subpackage WPAB_CampaignBay/includes
 */

// Exit if accessed directly.
if (!defined(&#039;ABSPATH&#039;)) {
	exit;
}

/**
 * The Pricing Engine class.
 *
 * This class is responsible for applying discount logic by hooking into WooCommerce
 * pricing filters and actions. It is the &quot;engine&quot; that drives the customer-facing changes.
 *
 * @since      1.0.0
 * @package    WPAB_CampaignBay
 * @author     WP Anchor Bay &lt;wpanchorbay@gmail.com&gt;
 */
class ProductDiscount
{

	private $settings = array();

	private $product = null;

	private $campaigns = array();

	private $data = array();

	/**
	 * Private constructor to prevent direct instantiation.
	 * Use the static `create()` method instead.
	 *
	 * @since 1.0.0
	 * @param WC_Product $product The product object to be processed.
	 */
	private function __construct(WC_Product $product)
	{
		$this-&gt;product = $product;
		$this-&gt;settings = Common::get_instance()-&gt;get_settings();
		$this-&gt;campaigns = CampaignManager::get_instance()-&gt;get_active_campaigns();
	}

	/**
	 * Static factory method to begin the processing chain.
	 *
	 * This is the entry point. It creates an instance of the processor for a given product.
	 *
	 * @since 1.0.0
	 * @param WC_Product|int $product The product object or product ID.
	 * @return self|null Returns a new instance for chaining, or null if the product is invalid.
	 */
	public static function create($product)
	{
		if (is_numeric($product)) {
			$product = wc_get_product($product);
		}

		if (!$product instanceof WC_Product) {
			// Return null or a dummy object if the product is invalid to prevent fatal errors.
			return null;
		}

		return new self($product);
	}


	/**
	 * Calculates and applies the best discount to the product object.
	 *
	 * This is the main &quot;worker&quot; method. It loops through campaigns, finds the best
	 * price, sets the sale price on the product object, and attaches custom
	 * metadata about the discount.
	 *
	 * @since 1.0.0
	 * @return self Returns the instance to allow for further chaining.
	 */
	public function apply_discounts()
	{

		// if variable product just apply on variations
		if (Woocommerce::product_type_is($this-&gt;product, &#039;variable&#039;)) {
			return $this-&gt;apply_discounts_on_variations();
		}
		$original_price = (float) Woocommerce::get_product_regular_price($this-&gt;product);
		$base_price = (float) Woocommerce::get_product_base_price($this-&gt;product);
		$best_price = null;
		$applied_campaign = null;
		$applied_tier = null;
		$this-&gt;data = array(
			&#039;original_price&#039; =&gt; $original_price,
			&#039;base_price&#039; =&gt; $base_price,
			&#039;on_discount&#039; =&gt; false,
			&#039;is_on_sale&#039; =&gt; false,
		);

		foreach ($this-&gt;campaigns as $campaign) {
			if ($campaign-&gt;get_type() !== &#039;scheduled&#039; &amp;&amp; $campaign-&gt;get_type() !== &#039;earlybird&#039;) {
				/**
				 * Fires when a product-level campaign type not native to the free version is being processed.
				 *
				 * This hook is the primary entry point for Pro add-ons to integrate their own
				 * campaign logic into the pricing engine. A function hooked here should
				 * perform its calculations and can modify the `$product_discount_processor`
				 * object directly if needed (since it&#039;s passed by reference).
				 *
				 * @since 1.0.0
				 * @hook campaignbay_product_discount_calculation_pro
				 *
				 * @param \WC_Product $product The product object currently being processed.
				 * @param \WpabCampaignBay\Engine\ProductDiscount $product_discount_processor The instance of the current pricing processor object.
				 * @param object $campaign The campaign object that needs to be processed.
				 * @param float $original_price The product&#039;s original regular price.
				 * @param float $base_price The price being used as the starting point for calculations (could be sale price).
				 * @param float|null $best_price The best discounted price found so far in the loop.
				 * @param object|null $applied_campaign The campaign object corresponding to the current best price.
				 * @param array|null $applied_tier The tier data (if any) corresponding to the current best price.
				 */
				do_action(&#039;campaignbay_product_discount_calculation_pro&#039;, $this-&gt;product, $this, $campaign, $original_price, $base_price, $best_price, $applied_campaign, $applied_tier);

				continue;
			}
			if (!$campaign-&gt;is_applicable_to_product($this-&gt;product)) {
				continue;
			}
			if ($campaign-&gt;get_type() === &#039;earlybird&#039;) {
				$tier = Helper::earlybird_current_tier($campaign);
				$new_price = $this-&gt;calculate_earlybird_price($tier, $base_price);
			} elseif ($campaign-&gt;get_type() === &#039;scheduled&#039;)
				$new_price = $this-&gt;calculate_scheduled_price($campaign, $base_price);

			if ($this-&gt;is_better_price($new_price, $best_price)) {
				$best_price = $new_price;
				$applied_campaign = $campaign;
				$applied_tier = $tier ?? null;
			}
		}
		if ($applied_campaign !== null) {

			/**
			 * Fires within the campaign loop, just before the current campaign&#039;s price is compared to the best price.
			 *
			 * This action hook is a powerful entry point for Pro add-ons to run their own logic for custom
			 * campaign types. A Pro add-on could hook here, check if `$campaign` is a &quot;Pro&quot; type,
			 * run its own price calculation, and then use the &#039;campaignbay_product_best_price&#039; filter
			 * to inject its calculated price into the competition.
			 *
			 * @since 1.0.0
			 * @hook campaignbay_product_discount_before_appling
			 *
			 * @param WC_Product $product          The WooCommerce product object currently being processed.
			 * @param object     $product_discount The instance of the ProductDiscount class.
			 * @param object     $campaign         The specific campaign object being evaluated in this loop iteration.
			 * @param float      $original_price   The product&#039;s original regular price.
			 * @param float      $base_price       The price being used as the base for calculations (could be regular or sale price).
			 * @param float|null $best_price       The best discounted price found so far from previous campaigns in the loop.
			 * @param object|null $applied_campaign The campaign object that corresponds to the current best price.
			 * @param object|null $applied_tier     The specific tier (if any) of the applied campaign.
			 */
			do_action(&#039;campaignbay_product_discount_before_appling&#039;, $this-&gt;product, $this, $campaign, $original_price, $base_price, $best_price, $applied_campaign, $applied_tier);

			$this-&gt;data[&#039;on_discount&#039;] = true;
			$this-&gt;data[&#039;is_simple&#039;] = true;
			$data = array(
				&#039;campaign&#039; =&gt; $applied_campaign-&gt;get_id(),
				&#039;campaign_title&#039; =&gt; $applied_campaign-&gt;get_title(),
				&#039;price&#039; =&gt; $best_price,
				&#039;discount&#039; =&gt; $base_price - $best_price,
				&#039;message_format&#039; =&gt; $applied_campaign-&gt;get_settings()[&#039;message_format&#039;] ?? &#039;&#039;,
				&#039;display_as_regular_price&#039; =&gt; $applied_campaign-&gt;get_settings()[&#039;display_as_regular_price&#039;] ?? false
			);
			if ($applied_campaign-&gt;get_type() === &#039;scheduled&#039;) {
				$data[&#039;value&#039;] = $applied_campaign-&gt;get_discount_value() ?? null;
				$data[&#039;type&#039;] = $applied_campaign-&gt;get_discount_type() ?? null;
			}
			if ($applied_campaign-&gt;get_type() === &#039;earlybird&#039;) {
				$data[&#039;value&#039;] = $applied_tier[&#039;value&#039;];
				$data[&#039;type&#039;] = $applied_tier[&#039;type&#039;];
			}
			$this-&gt;data[&#039;simple&#039;] = $data;

			$this-&gt;product-&gt;set_price($this-&gt;data[&#039;simple&#039;][&#039;price&#039;]);

			$this-&gt;product-&gt;set_regular_price($this-&gt;data[&#039;base_price&#039;]);
			// add on sale badge
			if (!$this-&gt;data[&#039;simple&#039;][&#039;display_as_regular_price&#039;]) {
				$this-&gt;data[&#039;is_on_sale&#039;] = true;
			} else {
				$this-&gt;data[&#039;is_on_sale&#039;] = false;
				$this-&gt;product-&gt;set_regular_price($this-&gt;data[&#039;simple&#039;][&#039;price&#039;]);
			}

			/**
			 * Fires within the campaign loop, just before the current campaign&#039;s price is compared to the best price.
			 *
			 * This action hook is a powerful entry point for Pro add-ons to run their own logic for custom
			 * campaign types. A Pro add-on could hook here, check if `$campaign` is a &quot;Pro&quot; type,
			 * run its own price calculation, and then use the &#039;campaignbay_product_best_price&#039; filter
			 * to inject its calculated price into the competition.
			 *
			 * @since 1.0.0
			 * @hook campaignbay_product_discount_before_appling
			 *
			 * @param WC_Product $product          The WooCommerce product object currently being processed.
			 * @param object     $product_discount The instance of the ProductDiscount class.
			 * @param object     $campaign         The specific campaign object being evaluated in this loop iteration.
			 * @param float      $original_price   The product&#039;s original regular price.
			 * @param float      $base_price       The price being used as the base for calculations (could be regular or sale price).
			 * @param float|null $best_price       The best discounted price found so far from previous campaigns in the loop.
			 * @param object|null $applied_campaign The campaign object that corresponds to the current best price.
			 * @param object|null $applied_tier     The specific tier (if any) of the applied campaign.
			 */
			do_action(&#039;campaignbay_product_discount_after_appling&#039;, $this-&gt;product, $this, $campaign, $original_price, $base_price, $best_price, $applied_campaign, $applied_tier);

		}

		/**
		 * Filters the final array of calculated discount metadata before it is attached to the product object.
		 *
		 * This is the primary filter for extending or modifying the data that gets stored with the product.
		 * A Pro add-on could use this to add its own flags or data (e.g., &#039;free_shipping_applied&#039; =&gt; true)
		 * to the metadata, which can then be used by other parts of the plugin, like the cart.
		 *
		 * @since 1.0.0
		 * @hook campaignbay_product_discount_meta
		 *
		 * @param array      $data    The array of calculated discount data for the product.
		 * @param WC_Product $product The WooCommerce product object this data will be attached to.
		 *
		 * @return array The modified data array.
		 */
		$this-&gt;product-&gt;add_meta_data(&#039;campaignbay&#039;, apply_filters(&#039;campaignbay_product_discount_meta&#039;, $this-&gt;data, $this-&gt;product), true);
		return $this;
	}

	/**
	 * Summary of apply_discounts_on_variations
	 * 
	 * @since 1.0.0
	 * @return self Returns the instance to allow for further chaining.
	 */
	public function apply_discounts_on_variations()
	{
		$prices = Woocommerce::get_variation_prices($this-&gt;product);
		$this-&gt;data = array(
			&#039;on_discount&#039; =&gt; false,
		);

		if (empty($prices[&#039;price&#039;])) {
			return $this;
		}
		foreach ($prices[&#039;price&#039;] as $key =&gt; $value) {
			$meta = Woocommerce::get_product($key)-&gt;get_meta(&#039;campaignbay&#039;);
			if ($meta[&#039;on_discount&#039;])
				$this-&gt;data[&#039;on_discount&#039;] = true;

			if ($meta[&#039;is_on_sale&#039;])
				$this-&gt;data[&#039;is_on_sale&#039;] = true;

			if (isset($meta[&#039;is_simple&#039;]) &amp;&amp; $meta[&#039;is_simple&#039;]) {
				$this-&gt;data[&#039;is_simple&#039;] = $meta[&#039;is_simple&#039;];
				if (!isset($meta[&#039;simple&#039;]))
					$this-&gt;data[&#039;simple&#039;] = array();
				$this-&gt;data[&#039;simple&#039;][$key] = $meta[&#039;simple&#039;];
			}
		}

		$this-&gt;product-&gt;add_meta_data(&#039;campaignbay&#039;, $this-&gt;data, true);
		return $this;
	}

	/**
	 * Returns the final, modified product object.
	 *
	 * @since 1.0.0
	 * @return WC_Product The processed product object.
	 */
	public function get_product()
	{
		return $this-&gt;product;
	}


	/**
	 * Handles the price calculation for &quot;scheduled&quot; type campaigns.
	 * This is a sub-dispatcher that checks for percentage or fixed discounts.
	 *
	 * @since 1.0.0
	 * @param object $campaign The campaign object.
	 * @param float  $base_price The price before discount.
	 * @return float The calculated price.
	 */
	public function calculate_scheduled_price($campaign, $base_price)
	{
		$discount_type = $campaign-&gt;get_discount_type();
		$discount_value = $campaign-&gt;get_discount_value();
		$calculated_price = $base_price;

		if ($discount_type === &#039;percentage&#039;) {
			$calculated_price = $this-&gt;calculate_percentage_price($base_price, $discount_value);
		} elseif ($discount_type === &#039;fixed&#039;) {
			$calculated_price = $this-&gt;calculate_fixed_price($base_price, $discount_value);
		}

		return $calculated_price;
	}

	public function calculate_earlybird_price($tier, $base_price)
	{
		$discount_type = $tier[&#039;type&#039;];
		$discount_value = $tier[&#039;value&#039;];
		$calculated_price = $base_price;
		if ($discount_type === &#039;percentage&#039;) {
			$calculated_price = $this-&gt;calculate_percentage_price($base_price, $discount_value);
		} elseif ($discount_type === &#039;fixed&#039; || $discount_type === &#039;currency&#039;) {
			$calculated_price = $this-&gt;calculate_fixed_price($base_price, $discount_value);
		}
		return $calculated_price;
	}

	/**
	 * Calculates a price based on a fixed amount discount.
	 *
	 * @since 1.0.0
	 * @param float $base_price The price before discount.
	 * @param float $discount_value The fixed amount to subtract.
	 * @return float The final price, ensuring it&#039;s not below zero.
	 */
	public function calculate_fixed_price($base_price, $discount_value)
	{
		return max(0, $base_price - $discount_value);
	}

	/**
	 * Calculates a price based on a percentage discount.
	 *
	 * @since 1.0.0
	 * @param float $base_price The price before discount.
	 * @param float $discount_value The percentage to subtract (e.g., 10 for 10%).
	 * @return float The final price, ensuring it&#039;s not below zero.
	 */
	public function calculate_percentage_price($base_price, $discount_value)
	{
		$discount_amount = ($discount_value / 100) * $base_price;
		return max(0, $base_price - $discount_amount);
	}

	public function is_better_price($new_price, $current_best_price)
	{
		if ($new_price === null)
			return false;
		if ($current_best_price === null)
			return true;
		$setting = Common::get_instance()-&gt;get_settings(&#039;product_priorityMethod&#039;);

		if ($setting === &#039;apply_highest&#039;) {
			return $new_price &lt; $current_best_price;
		} elseif ($setting === &#039;apply_lowest&#039;) {
			return $new_price &gt; $current_best_price;
		} elseif ($setting === &#039;apply_first&#039;) {
			return $current_best_price === null;
		}
		return false;
	}


}</code></pre>
            </article>
            </div>
        </div>
        <a href="#top" class="phpdocumentor-back-to-top"><i class="fas fa-chevron-circle-up"></i></a>

    </main>

    <footer class="phpdocumentor phpdocumentor-footer">
    <div class="phpdocumentor-section">
        <span>Campaignbay developer documentation generated by <a href="http://www.phpdoc.org/">phpDocumentor</a> on November 11th, 2025 at 11:24 am.</span>
    </div>
</footer>

    <script>
        cssVars({});
    </script>
    <script>
        var searchParams = {
            'searchIndex': '..\/js\/searchIndex.json'
        };
    </script>
    <script src="../js/searchIndex.js?updated=1762860254"></script>
    <script src="../js/search.js?updated=1762860254"></script>
</body>
</html>
